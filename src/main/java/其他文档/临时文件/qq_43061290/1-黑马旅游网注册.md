# 1-黑马旅游网注册
## 注册

<img src="https://img-blog.csdnimg.cn/20200315154004293.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMDYxMjkw,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"/>

## 业务逻辑

<img src="https://img-blog.csdnimg.cn/20200315154036972.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMDYxMjkw,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"/>

## 前端的注册

```
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>注册</title>
        <link rel="stylesheet" type="text/css" href="css/common.css">
        <link rel="stylesheet" href="css/register.css">
		<!--导入jquery-->
		<script src="js/jquery-3.3.1.js"></script>

		<script>
			/*
				表单校验：
					1.用户名：单词字符，长度8到20位
					2.密码：单词字符，长度8到20位
					3.email：邮件格式
					4.姓名：非空
					5.手机号：手机号格式
					6.出生日期：非空
					7.验证码：非空
			 */

			//校验用户名
			//单词字符，长度8到20位
			function checkUsername() {<!-- -->
                //1.获取用户名值
				var username = $("#username").val();
				//2.定义正则
				var reg_username = /^\w{<!-- -->8,20}$/;
				
				//3.判断，给出提示信息
			    var flag = reg_username.test(username);
			    if(flag){<!-- -->
			        //用户名合法
                    $("#username").css("border","");
				}else{<!-- -->
			        //用户名非法,加一个红色边框
					$("#username").css("border","1px solid red");
				}
			    
                return flag;
            }

            //校验密码
            function checkPassword() {<!-- -->
                //1.获取密码值
                var password = $("#password").val();
                //2.定义正则
                var reg_password = /^\w{<!-- -->8,20}$/;

                //3.判断，给出提示信息
                var flag = reg_password.test(password);
                if(flag){<!-- -->
                    //密码合法
                    $("#password").css("border","");
                }else{<!-- -->
                    //密码非法,加一个红色边框
                    $("#password").css("border","1px solid red");
                }

                return flag;
            }

            //校验邮箱
			function checkEmail(){<!-- -->
			    //1.获取邮箱
				var email = $("#email").val();
				//2.定义正则		itcast@163.com
				var reg_email = /^\w+@\w+\.\w+$/;

				//3.判断
				var flag = reg_email.test(email);
				if(flag){<!-- -->
                    $("#email").css("border","");
				}else{<!-- -->
                    $("#email").css("border","1px solid red");
				}

				return flag;
			}

			$(function () {<!-- -->
                //当表单提交时，调用所有的校验方法
				$("#registerForm").submit(function(){<!-- -->
					//1.发送数据到服务器
					if(checkUsername() &amp;&amp; checkPassword() &amp;&amp; checkEmail()){<!-- -->
					    //校验通过,发送ajax请求，提交表单的数据   username=zhangsan&amp;password=123

						$.post("registUserServlet",$(this).serialize(),function(data){<!-- -->
							//处理服务器响应的数据  data  {flag:true,errorMsg:"注册失败"}

							if(data.flag){<!-- -->
							    //注册成功，跳转成功页面
								location.href="register_ok.html";
							}else{<!-- -->
							    //注册失败,给errorMsg添加提示信息
								$("#errorMsg").html(data.errorMsg);

							}
						});

					}
					//2.不让页面跳转
                    return false;
                    //如果这个方法没有返回值，或者返回为true，则表单提交，如果返回为false，则表单不提交
				});

                //当某一个组件失去焦点是，调用对应的校验方法
				$("#username").blur(checkUsername);
                $("#password").blur(checkPassword);
                $("#email").blur(checkEmail);


            });


		</script>


    </head>
	<body>
	<!--引入头部-->
	
        <!-- 头部 end -->
    	
    		
    			
    				<p>新用户注册</p>
    				<p>USER REGISTER</p>
    			
    			
					
					<!--注册表单-->
    				<form id="registerForm" action="user">
						<!--提交处理请求的标识符-->
						<input type="hidden" name="action" value="register">
    					<table style="margin-top: 25px;">
    						<tr>
    							<td class="td_left">
    								<label for="username">用户名</label>
    							</td>
    							<td class="td_right">
    								<input type="text" id="username" name="username" placeholder="请输入账号">
    							</td>
    						</tr>
    						<tr>
    							<td class="td_left">
    								<label for="password">密码</label>
    							</td>
    							<td class="td_right">
    								<input type="text" id="password" name="password" placeholder="请输入密码">
    							</td>
    						</tr>
    						<tr>
    							<td class="td_left">
    								<label for="email">Email</label>
    							</td>
    							<td class="td_right">
    								<input type="text" id="email" name="email" placeholder="请输入Email">
    							</td>
    						</tr>
    						<tr>
    							<td class="td_left">
    								<label for="name">姓名</label>
    							</td>
    							<td class="td_right">
    								<input type="text" id="name" name="name" placeholder="请输入真实姓名">
    							</td>
    						</tr>
    						<tr>
    							<td class="td_left">
    								<label for="telephone">手机号</label>
    							</td>
    							<td class="td_right">
    								<input type="text" id="telephone" name="telephone" placeholder="请输入您的手机号">
    							</td>
    						</tr>
    						<tr>
    							<td class="td_left">
    								<label for="sex">性别</label>
    							</td>
    							<td class="td_right gender">
    								<input type="radio" id="sex" name="sex" value="男" checked> 男
    								<input type="radio" name="sex" value="女"> 女
    							</td>
    						</tr>
    						<tr>
    							<td class="td_left">
    								<label for="birthday">出生日期</label>
    							</td>
    							<td class="td_right">
    								<input type="date" id="birthday" name="birthday" placeholder="年/月/日">
    							</td>
    						</tr>
    						<tr>
    							<td class="td_left">
    								<label for="check">验证码</label>
    							</td>
    							<td class="td_right check">
    								<input type="text" id="check" name="check" class="check">
    								<img src="checkCode" height="32px" alt="" onclick="changeCheckCode(this)">
									<script type="text/javascript">
										//图片点击事件
										function changeCheckCode(img) {<!-- -->
											img.src="checkCode?"+new Date().getTime();
                                        }
									</script>
    							</td>
    						</tr>
    						<tr>
    							<td class="td_left"> 
    							</td>
    							<td class="td_right check"> 
    								<input type="submit" class="submit" value="注册">
									
    							</td>
    						</tr>
    					</table>
    				</form>
    			
    			
    				<p>
    					已有账号？
    					[立即登录](#)
    				</p>
    			
    		
    	
        <!--引入尾部-->
    	
		<!--导入布局js，共享header和footer-->
		<script type="text/javascript" src="js/include.js"></script>
    	
    </body>
</html>

```

## 表单校验

```
//校验用户名
//单词字符，长度8到20位
function checkUsername() {<!-- -->
             //1.获取用户名值
   var username = $("#username").val();
   //2.定义正则
   var reg_username = /^\w{<!-- -->8,20}$/;
   
   //3.判断，给出提示信息
    var flag = reg_username.test(username);
    if(flag){<!-- -->
        //用户名合法
                 $("#username").css("border","");
   }else{<!-- -->
        //用户名非法,加一个红色边框
      $("#username").css("border","1px solid red");
   }
    
             return flag;
         }

         //校验密码
         function checkPassword() {<!-- -->
             //1.获取密码值
             var password = $("#password").val();
             //2.定义正则
             var reg_password = /^\w{<!-- -->8,20}$/;

             //3.判断，给出提示信息
             var flag = reg_password.test(password);
             if(flag){<!-- -->
                 //密码合法
                 $("#password").css("border","");
             }else{<!-- -->
                 //密码非法,加一个红色边框
                 $("#password").css("border","1px solid red");
             }

             return flag;
         }

         //校验邮箱
function checkEmail(){<!-- -->
    //1.获取邮箱
   var email = $("#email").val();
   //2.定义正则      itcast@163.com
   var reg_email = /^\w+@\w+\.\w+$/;

   //3.判断
   var flag = reg_email.test(email);
   if(flag){<!-- -->
                 $("#email").css("border","");
   }else{<!-- -->
                 $("#email").css("border","1px solid red");
   }

   return flag;
}

$(function () {<!-- -->
             //当表单提交时，调用所有的校验方法
   $("#registerForm").submit(function(){<!-- -->

                 return checkUsername() &amp;&amp; checkPassword() &amp;&amp; checkEmail();
                 //如果这个方法没有返回值，或者返回为true，则表单提交，如果返回为false，则表单不提交
   });

             //当某一个组件失去焦点是，调用对应的校验方法
   		$("#username").blur(checkUsername);
             $("#password").blur(checkPassword);
             $("#email").blur(checkEmail);


         });

```

## 异步(ajax)提交表单

在此使用异步提交表单是为了获取服务器响应的数据。因为我们前台使用的是html作为视图层，不能够直接从servlet相关的域对象获取值，只能通过ajax获取响应数据

<img src="https://img-blog.csdnimg.cn/20200315182535704.png" alt="在这里插入图片描述"/>

## 后台代码实现

## 编写RegistUserServlet

```
package cn.itcast.travel.web.servlet;

import cn.itcast.travel.domain.ResultInfo;
import cn.itcast.travel.domain.User;
import cn.itcast.travel.service.UserService;
import cn.itcast.travel.service.impl.UserServiceImpl;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.commons.beanutils.BeanUtils;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.util.Map;

@WebServlet("/registUserServlet")
public class RegistUserServlet extends HttpServlet {<!-- -->
    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {<!-- -->


        //验证校验
        String check = request.getParameter("check");
        //从sesion中获取验证码
        HttpSession session = request.getSession();
        String checkcode_server = (String) session.getAttribute("CHECKCODE_SERVER");
        session.removeAttribute("CHECKCODE_SERVER");//为了保证验证码只能使用一次
        //比较
        if(checkcode_server == null || !checkcode_server.equalsIgnoreCase(check)){<!-- -->
            //验证码错误
            ResultInfo info = new ResultInfo();
            //注册失败
            info.setFlag(false);
            info.setErrorMsg("验证码错误");
            //将info对象序列化为json
            ObjectMapper mapper = new ObjectMapper();
            String json = mapper.writeValueAsString(info);
            response.setContentType("application/json;charset=utf-8");
            response.getWriter().write(json);
            return;
        }

        //1.获取数据
        Map<String, String[]> map = request.getParameterMap();

        //2.封装对象
        User user = new User();
        try {<!-- -->
            BeanUtils.populate(user,map);
        } catch (IllegalAccessException e) {<!-- -->
            e.printStackTrace();
        } catch (InvocationTargetException e) {<!-- -->
            e.printStackTrace();
        }

        //3.调用service完成注册
        UserService service = new UserServiceImpl();
        boolean flag = service.regist(user);
        ResultInfo info = new ResultInfo();
        //4.响应结果
        if(flag){<!-- -->
            //注册成功
            info.setFlag(true);
        }else{<!-- -->
            //注册失败
            info.setFlag(false);
            info.setErrorMsg("注册失败!");
        }

        //将info对象序列化为json
        ObjectMapper mapper = new ObjectMapper();
        String json = mapper.writeValueAsString(info);

        //将json数据写回客户端
        //设置content-type
        response.setContentType("application/json;charset=utf-8");
        response.getWriter().write(json);


    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {<!-- -->
        this.doPost(request, response);
    }
}


```

## 编写UserService以及UserServiceImpl

```
public class UserServiceImpl implements UserService {<!-- -->

    private UserDao userDao = new UserDaoImpl();
    /**
     * 注册用户
     * @param user
     * @return
     */
    @Override
    public boolean regist(User user) {<!-- -->
        //1.根据用户名查询用户对象
        User u = userDao.findByUsername(user.getUsername());
        //判断u是否为null
        if(u != null){<!-- -->
            //用户名存在，注册失败
            return false;
        }
        //2.保存用户信息
        userDao.save(user);
        return true;
    }
}

```

## 编写UserDao以及UserDaoImpl

```
public class UserDaoImpl implements UserDao {<!-- -->

    private JdbcTemplate template = new JdbcTemplate(JDBCUtils.getDataSource());

    @Override
    public User findByUsername(String username) {<!-- -->
        User user = null;
        try {<!-- -->
            //1.定义sql
            String sql = "select * from tab_user where username = ?";
            //2.执行sql
            user = template.queryForObject(sql, new BeanPropertyRowMapper<User>(User.class), username);
        } catch (Exception e) {<!-- -->

        }

        return user;
    }

    @Override
    public void save(User user) {<!-- -->
        //1.定义sql
        String sql = "insert into tab_user(username,password,name,birthday,sex,telephone,email) values(?,?,?,?,?,?,?)";
        //2.执行sql

        template.update(sql,user.getUsername(),
                    user.getPassword(),
                user.getName(),
                user.getBirthday(),
                user.getSex(),
                user.getTelephone(),
                user.getEmail());
    }
}

```

## 邮件激活

```
为什么要进行邮件激活？为了保证用户填写的邮箱是正确的。将来可以推广一些宣传信息，到用户邮箱中。

```

## 发送邮件

1.申请邮箱 2.开启授权码 3.在MailUtils中设置自己的邮箱账号和密码(授权码)

<img src="https://img-blog.csdnimg.cn/20200315211615367.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMDYxMjkw,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"/>

邮件工具类：MailUtils，调用其中sendMail方法可以完成邮件发送

## 用户点击邮件激活

经过分析，发现，用户激活其实就是修改用户表中的status为‘Y’

<img src="https://img-blog.csdnimg.cn/20200316203132866.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMDYxMjkw,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"/>

## 分析：

<img src="https://img-blog.csdnimg.cn/20200316203204675.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMDYxMjkw,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"/> 发送邮件代码： <img src="https://img-blog.csdnimg.cn/20200316203230896.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMDYxMjkw,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"/> 修改保存Dao代码，加上存储status和code 的代码逻辑 <img src="https://img-blog.csdnimg.cn/20200316203253438.png" alt="在这里插入图片描述"/> 激活代码实现：

## ActiveUserServlet

```
//1.获取激活码
String code = request.getParameter("code");
if(code != null){<!-- -->
    //2.调用service完成激活
    UserService service = new UserServiceImpl();
    boolean flag = service.active(code);

    //3.判断标记
    String msg = null;
    if(flag){<!-- -->
        //激活成功
        msg = "激活成功，请<a href='login.html'>登录</a>";
    }else{<!-- -->
        //激活失败
        msg = "激活失败，请联系管理员!";
    }
    response.setContentType("text/html;charset=utf-8");
    response.getWriter().write(msg);

```

## UserService：active

```
@Override
public boolean active(String code) {<!-- -->
    //1.根据激活码查询用户对象
    User user = userDao.findByCode(code);
    if(user != null){<!-- -->
        //2.调用dao的修改激活状态的方法
        userDao.updateStatus(user);
        return true;
    }else{<!-- -->
        return false;
    }

}

```

## UserDao：findByCode updateStatus

```
/**
 * 根据激活码查询用户对象
 * @param code
 * @return
 */
@Override
public User findByCode(String code) {<!-- -->
    User user = null;
    try {<!-- -->
        String sql = "select * from tab_user where code = ?";

        user = template.queryForObject(sql,new BeanPropertyRowMapper<User>(User.class),code);
    } catch (DataAccessException e) {<!-- -->
        e.printStackTrace();
    }

    return user;
}

/**
 * 修改指定用户激活状态
 * @param user
 */
@Override
public void updateStatus(User user) {<!-- -->
    String sql = " update tab_user set status = 'Y' where uid=?";
    template.update(sql,user.getUid());
}

```
# **文章地址： **https://blog.csdn.net/qq_43061290/article/details/104879760